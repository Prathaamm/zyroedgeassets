<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZyroEdge: Enterprise IoT Platform</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; }
    
    :root {
      --bg-1: #0a0e1a; --bg-2: #0f1624; --bg-3: #151d2d;
      --card: rgba(20,40,70,0.4); --card-hover: rgba(20,40,70,0.6);
      --accent: #00d4ff; --accent-2: #4df3c5; --accent-3: #00b8e6;
      --muted: #8ba3b8; --text: #e0f2fe; --text-secondary: #cbd5e1;
      --danger: #ff6b6b; --danger-light: #ff8787; --critical: #ff2d2d;
      --warn: #fbbf24; --success: #10b981; --success-dark: #059669;
      --shadow: rgba(0,0,0,0.7); --glow: rgba(0,212,255,0.1);
    }
    
    html, body {
      height: 100%; margin: 0; padding: 0;
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: 
        radial-gradient(ellipse 1400px 700px at 20% 10%, rgba(0,212,255,0.06), transparent),
        radial-gradient(ellipse 900px 600px at 80% 70%, rgba(77,243,197,0.04), transparent),
        linear-gradient(135deg, var(--bg-1) 0%, var(--bg-2) 50%, #0a1a2e 100%);
      background-attachment: fixed;
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
      line-height: 1.6;
    }

    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: rgba(0,212,255,0.05); }
    ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, var(--accent), var(--accent-2)); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, var(--accent-3), var(--accent)); }

    .login-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(135deg, rgb(0 8 24 / 95%) 0%, rgb(0 8 25 / 95%) 50%, rgb(0 8 25 / 95%) 100%);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(12px);
      animation: overlayFadeIn 0.4s ease-out;
    }
    @keyframes overlayFadeIn { from { opacity: 0; backdrop-filter: blur(0px); } to { opacity: 1; backdrop-filter: blur(12px); } }
    .login-overlay.active { display: flex; }

    .registration-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(135deg, rgb(0 8 24 / 95%) 0%, rgb(0 8 25 / 95%) 50%, rgb(0 8 25 / 95%) 100%);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(12px);
      animation: overlayFadeIn 0.4s ease-out;
    }
    .registration-overlay.active { display: flex; }
    
    .login-container {
      display: flex;
      width: 100%;
      max-width: 1320px;
      gap: 60px;
      padding: 60px 40px;
      align-items: center;
      animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
    
    .login-section { flex: 1; }
    .login-branding { color: var(--text); }
    .login-branding h1 {
      margin: 0; font-size: 56px; font-weight: 900; letter-spacing: -1px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .login-branding p {
      margin: 16px 0 0 0; color: var(--text-secondary); font-size: 18px; font-weight: 500; letter-spacing: 0.5px;
    }
    
    .login-features { margin-top: 50px; display: flex; flex-direction: column; gap: 24px; }
    .feature-item {
      display: flex; gap: 18px; align-items: flex-start;
      padding: 16px; border-radius: 12px;
      background: rgba(0,212,255,0.05); border: 1px solid rgba(0,212,255,0.1);
      transition: all 0.3s ease;
    }
    .feature-item:hover { background: rgba(0,212,255,0.08); border-color: rgba(0,212,255,0.2); transform: translateX(8px); }
    .feature-icon { font-size: 32px; flex-shrink: 0; filter: drop-shadow(0 0 8px rgba(0,212,255,0.3)); }
    .feature-text { flex: 1; }
    .feature-text strong { display: block; font-size: 15px; font-weight: 700; color: var(--accent); margin-bottom: 6px; letter-spacing: 0.5px; }
    .feature-text span { font-size: 13px; color: var(--muted); line-height: 1.5; }
    
    .login-box {
      background: linear-gradient(135deg, rgba(25,40,70,0.9) 0%, rgba(20,32,55,0.85) 100%);
      border: 2px solid rgba(0,212,255,0.3);
      border-radius: 28px;
      padding: 56px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 25px 70px rgba(0,212,255,0.15), inset 0 1px 1px rgba(255,255,255,0.1), 0 0 60px rgba(0,212,255,0.05);
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
    }
    .login-box::before {
      content: ''; position: absolute; top: -50%; right: -50%; width: 200px; height: 200px;
      background: radial-gradient(circle, rgba(0,212,255,0.1), transparent);
      border-radius: 50%; pointer-events: none;
    }
    
    .login-header { text-align: center; margin-bottom: 44px; position: relative; z-index: 1; }
    .login-logo {
      width: 350px; height: 120px; margin: 0 auto 24px;
      background: linear-gradient(135deg, rgba(0,212,255,0.4), rgba(77,243,197,0.3));
      border: 2.5px solid rgba(0,212,255,0.5);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      box-shadow: 0 15px 40px rgba(0,212,255,0.2), inset 0 1px 1px rgba(255,255,255,0.2);
      animation: logoFloat 3s ease-in-out infinite;
      overflow: hidden;
      position: relative;
    }
    .login-logo img { width: 250%; height: 110%; object-fit: contain; padding: 8px; }
    @keyframes logoFloat { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
    
    .login-header h1 {
      margin: 0; font-size: 36px; font-weight: 900;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }
    .login-header p { margin: 10px 0 0 0; color: var(--muted); font-size: 13px; letter-spacing: 1.5px; text-transform: uppercase; font-weight: 600; }
    
    .login-form { display: flex; flex-direction: column; gap: 20px; position: relative; z-index: 1; max-height: calc(100vh - 300px); overflow-y: auto; padding-right: 10px; }
    .login-form::-webkit-scrollbar { width: 6px; }
    .login-form::-webkit-scrollbar-track { background: rgba(0,212,255,0.05); border-radius: 10px; }
    .login-form::-webkit-scrollbar-thumb { background: linear-gradient(135deg, rgba(0,212,255,0.3), rgba(77,243,197,0.3)); border-radius: 10px; }
    .login-form::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, var(--accent), var(--accent-2)); }

    .form-group { display: flex; flex-direction: column; gap: 10px; }
    .form-label {
      font-size: 12px; font-weight: 700; text-transform: uppercase;
      color: var(--accent); letter-spacing: 0.8px;
      display: flex; align-items: center; gap: 8px;
    }
    .form-label::before {
      content: ''; display: inline-block; width: 4px; height: 4px;
      background: var(--accent); border-radius: 50%;
    }
    
    .form-input {
      padding: 15px 18px;
      background: rgba(0,0,0,0.3);
      border: 1.5px solid rgba(0,212,255,0.2);
      border-radius: 12px;
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .form-input:focus {
      outline: none;
      border-color: rgba(0,212,255,0.8);
      background: rgba(0, 5, 0, 0.3);
      box-shadow: 0 0 25px rgba(0,212,255,0.15), inset 0 0 15px rgba(0,212,255,0.05);
      transform: translateY(-2px);
    }
    .form-input::placeholder { color: rgba(139,163,184,0.4); }
    
    .login-btn {
      padding: 24px; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
      color: #051317; border: none; border-radius: 12px; font-size: 14px; font-weight: 800;
      text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; letter-spacing: 1.2px;
      box-shadow: 0 10px 35px rgba(0,212,255,0.25), inset 0 1px 1px rgba(255,255,255,0.3);
      position: relative; overflow: hidden;
    }
    .login-btn::before {
      content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0;
      background: rgba(255,255,255,0.2); border-radius: 50%; transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    .login-btn:hover::before { width: 300px; height: 300px; }
    .login-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 45px rgba(0,212,255,0.35), inset 0 1px 1px rgba(255,255,255,0.3);
    }
    
    .login-info {
      margin-top: 24px;
      padding: 18px;
      background: rgba(0,212,255,0.05);
      border: 1.5px solid rgba(0,212,255,0.2);
      border-radius: 14px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.8;
      position: relative; z-index: 1;
    }
    .login-info strong { color: var(--accent); display: block; margin-bottom: 8px; font-weight: 700; }
    
    .login-error {
      color: var(--danger);
      font-size: 12px;
      margin-top: 12px;
      padding: 14px;
      background: rgba(255,107,107,0.08);
      border: 1.5px solid rgba(255,107,107,0.4);
      border-radius: 10px;
      display: none;
      border-left: 4px solid var(--danger);
    }
    .login-error.show { display: flex; align-items: center; gap: 10px; }

    .switch-form-btn {
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 8px;
      margin-top: 12px;
    }
    .switch-form-btn:hover {
      color: var(--accent);
    }
    .switch-form-btn strong {
      color: var(--accent);
      font-weight: 800;
    }

    header {
      display: flex; align-items: center; justify-content: space-between; padding: 18px 40px;
      position: sticky; top: 0; z-index: 100;
      backdrop-filter: blur(25px) saturate(200%);
      background: linear-gradient(90deg, rgba(20,40,70,0.85) 0%, rgba(15,30,50,0.6) 100%);
      border-bottom: 1px solid rgba(0,212,255,0.15);
      box-shadow: 0 8px 40px rgba(0,0,0,0.4);
      animation: slideDown 0.5s ease-out;
    }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

    .brand { display: flex; align-items: center; gap: 16px; }
    .logo {
      width: 250px; height: 100px; border-radius: 14px; display: flex; align-items: center; justify-content: center;
      background: linear-gradient(135deg, rgba(0,212,255,0.25), rgba(77,243,197,0.2));
      border: 2px solid rgba(0,212,255,0.4);
      box-shadow: 0 8px 35px rgba(0,212,255,0.2);
      padding: 6px; transition: all 0.3s ease; overflow: hidden;
    }
    .logo img { width: 100%; height: 100%; object-fit: contain; }
    .logo:hover { transform: scale(1.08) rotate(5deg); box-shadow: 0 12px 45px rgba(0,212,255,0.3); }

    .brand h1 { margin: 0; font-size: 26px; background: linear-gradient(135deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; letter-spacing: -0.5px;
    }
    .tagline { font-size: 11px; color: var(--muted); font-style: italic; opacity: 0.8; letter-spacing: 0.3px; margin-top: 3px; }

    .header-stats { display: flex; gap: 24px; align-items: center; flex-wrap: wrap; }
    .header-info {
      display: flex; align-items: center; gap: 10px; padding: 10px 18px;
      background: rgba(20,40,70,0.7); border-radius: 12px; border: 1px solid rgba(0,212,255,0.2);
      font-size: 12px; color: var(--muted); transition: all 0.3s ease;
    }
    .header-info:hover { background: rgba(20,40,70,0.9); border-color: rgba(0,212,255,0.4); }
    .header-info .role-value { color: var(--accent); font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }

    #status, #systemHealth {
      font-weight: 700; font-size: 13px; padding: 10px 20px; border-radius: 12px; letter-spacing: 0.5px;
      transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;
    }
    #status { background: rgba(0,0,0,0.3); color: var(--muted); border: 1px solid rgba(255,255,255,0.08); }
    #systemHealth { border: 2px solid; box-shadow: 0 0 20px; animation: pulse-soft 2s ease-in-out infinite; }
    @keyframes pulse-soft { 0%, 100% { box-shadow: 0 0 20px currentColor; } 50% { box-shadow: 0 0 30px currentColor; } }

    #systemHealth.optimal {
      background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(16,185,129,0.1));
      color: #10b981; border-color: #10b981; box-shadow: 0 0 20px rgba(16,185,129,0.3);
    }
    #systemHealth.emergency_off {
      background: linear-gradient(135deg, rgba(255,76,76,0.2), rgba(255,76,76,0.1));
      color: #ff4c4c; border-color: #ff4c4c; box-shadow: 0 0 20px rgba(255,76,76,0.4);
      animation: pulse-emergency 1s ease-in-out infinite;
    }
    @keyframes pulse-emergency { 0%, 100% { box-shadow: 0 0 20px rgba(255,76,76,0.4); } 50% { box-shadow: 0 0 35px rgba(255,76,76,0.6); } }

    #systemHealth.safe {
      background: rgba(0,212,255,0.1); color: #00d4ff; border-color: rgba(0,212,255,0.5);
      box-shadow: 0 0 20px rgba(0,212,255,0.3);
    }
    #systemHealth.danger {
      background: rgba(255,107,107,0.1); color: #ff6b6b; border-color: rgba(255,107,107,0.5);
      box-shadow: 0 0 20px rgba(255,107,107,0.3);
    }

    .logout-btn {
      padding: 10px 20px; background: rgba(255,107,107,0.15); border: 1.5px solid rgba(255,107,107,0.4);
      color: var(--danger); border-radius: 10px; font-weight: 700; font-size: 12px; cursor: pointer;
      transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .logout-btn:hover {
      background: rgba(255,107,107,0.25);
      box-shadow: 0 0 20px rgba(255,107,107,0.2);
      transform: translateY(-2px);
    }

    .unit-selector {
      display: none; align-items: center; gap: 12px; padding: 10px 18px;
      background: rgba(20,40,70,0.7); border-radius: 12px; border: 1px solid rgba(77,243,197,0.3);
      transition: all 0.3s ease;
    }
    .unit-selector.show { display: flex; }
    .unit-selector:hover { background: rgba(20,40,70,0.9); border-color: rgba(77,243,197,0.5); }
    .unit-selector label { font-size: 12px; color: var(--muted); text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
    #unitSelector {
      padding: 8px 14px; background: rgba(0,0,0,0.3); color: var(--accent-2);
      border: 1.5px solid rgba(77,243,197,0.4); border-radius: 8px; font-weight: 700; font-size: 13px; cursor: pointer;
      transition: all 0.3s ease;
    }
    #unitSelector:hover, #unitSelector:focus { background: rgba(77,243,197,0.08); border-color: rgba(77,243,197,0.6); }

    #heroSection {
      padding: 80px 40px 50px; text-align: center;
      background: linear-gradient(180deg, rgba(0,212,255,0.05) 0%, transparent 60%);
      border-bottom: 1px solid rgba(0,212,255,0.08);
      animation: fadeIn 0.8s ease-in-out 0.2s both;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

    #heroSection h2 {
      font-size: 52px; margin: 0 0 16px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      font-weight: 900; letter-spacing: -1px;
    }
    #heroSection p { font-size: 19px; color: var(--text-secondary); margin: 0 0 48px; font-weight: 500; letter-spacing: 0.3px; }

    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 32px; max-width: 1250px; margin: 0 auto;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(20,40,70,0.6) 0%, rgba(15,30,50,0.4) 100%);
      border: 1.5px solid rgba(0,212,255,0.2); border-radius: 18px; padding: 32px 28px;
      backdrop-filter: blur(10px); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 10px 35px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.1);
      text-align: center; position: relative; overflow: hidden; cursor: pointer;
    }
    .stat-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, rgba(0,212,255,0.5), transparent);
    }
    .stat-card:hover {
      transform: translateY(-8px) scale(1.02);
      border-color: rgba(0,212,255,0.5);
      box-shadow: 0 20px 50px rgba(0,212,255,0.2), inset 0 1px 1px rgba(255,255,255,0.1);
    }
    .stat-icon { font-size: 42px; margin-bottom: 16px; display: block; filter: drop-shadow(0 0 10px rgba(0,212,255,0.2)); }
    .stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 1.2px; font-weight: 700; margin-bottom: 12px; }
    .stat-value { font-size: 42px; font-weight: 900; color: var(--accent); line-height: 1; letter-spacing: -1px; }

    .alert-split {
      display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;
    }
    .alert-stat-card {
      background: linear-gradient(135deg, rgba(20,40,70,0.6) 0%, rgba(15,30,50,0.4) 100%);
      border: 1.5px solid rgba(0,212,255,0.2); border-radius: 18px; padding: 24px;
      backdrop-filter: blur(10px); box-shadow: 0 10px 35px rgba(0,0,0,0.3);
      text-align: center; transition: all 0.3s ease; cursor: pointer; position: relative;
    }
    .alert-stat-card.active {
      border: 2px solid rgba(255,107,107,0.6);
      background: linear-gradient(135deg, rgba(255,107,107,0.15) 0%, rgba(255,76,76,0.08) 100%);
      box-shadow: 0 0 30px rgba(255,107,107,0.2), inset 0 0 20px rgba(255,107,107,0.08);
    }
    .alert-stat-card.active:hover {
      transform: translateY(-6px);
      box-shadow: 0 15px 40px rgba(255,107,107,0.3), inset 0 0 20px rgba(255,107,107,0.1);
      border-color: rgba(255,107,107,0.8);
    }
    .alert-stat-card.solved {
      border: 2px solid rgba(16,185,129,0.6);
      background: linear-gradient(135deg, rgba(16,185,129,0.15) 0%, rgba(16,185,129,0.08) 100%);
      box-shadow: 0 0 30px rgba(16,185,129,0.2), inset 0 0 20px rgba(16,185,129,0.08);
    }
    .alert-stat-card.solved:hover {
      transform: translateY(-6px);
      box-shadow: 0 15px 40px rgba(16,185,129,0.3), inset 0 0 20px rgba(16,185,129,0.1);
      border-color: rgba(16,185,129,0.8);
    }
    .alert-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; font-weight: 700; margin-bottom: 12px; }
    .alert-value { font-size: 36px; font-weight: 900; letter-spacing: -1px; }
    .alert-stat-card.active .alert-value { color: #ff6b6b; text-shadow: 0 0 10px rgba(255,107,107,0.3); }
    .alert-stat-card.solved .alert-value { color: #10b981; text-shadow: 0 0 10px rgba(16,185,129,0.3); }
    .alert-badge { display: inline-block; font-size: 10px; padding: 4px 10px; border-radius: 20px; margin-top: 8px; font-weight: 700; }
    .alert-stat-card.active .alert-badge { background: rgba(255,107,107,0.3); color: #ff6b6b; box-shadow: 0 0 10px rgba(255,107,107,0.2); }
    .alert-stat-card.solved .alert-badge { background: rgba(16,185,129,0.3); color: #10b981; box-shadow: 0 0 10px rgba(16,185,129,0.2); }

    .time-card {
      background: linear-gradient(135deg, rgba(20,40,70,0.6) 0%, rgba(15,30,50,0.4) 100%);
      border: 1.5px solid rgba(0,212,255,0.2); border-radius: 18px; padding: 24px;
      backdrop-filter: blur(10px); box-shadow: 0 10px 35px rgba(0,0,0,0.3);
      text-align: center; transition: all 0.3s ease; cursor: pointer; position: relative;
    }
    .time-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, rgba(0,212,255,0.5), transparent);
    }
    .time-card:hover {
      transform: translateY(-6px) scale(1.02);
      border-color: rgba(0,212,255,0.4);
      box-shadow: 0 15px 45px rgba(0,212,255,0.15), 0 0 20px rgba(0,212,255,0.1);
    }
    .time-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; font-weight: 700; margin-bottom: 12px; }
    .time-display { font-size: 32px; font-weight: 900; color: var(--accent); line-height: 1.2; letter-spacing: -1px; }
    .time-date { font-size: 12px; color: var(--accent-2); font-weight: 700; margin-top: 8px; }

    nav {
      display: flex; gap: 12px; padding: 22px 40px; justify-content: center;
      background: rgba(0,0,0,0.25); border-bottom: 1px solid rgba(0,212,255,0.08);
      flex-wrap: wrap; backdrop-filter: blur(10px);
    }

    nav button {
      padding: 13px 26px; background: rgba(20,40,70,0.4); color: var(--muted);
      border: 1.5px solid rgba(0,212,255,0.15); border-radius: 14px; cursor: pointer;
      font-weight: 700; letter-spacing: 0.5px; font-size: 13px;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative; overflow: hidden;
    }
    nav button::before {
      content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0,212,255,0.2), transparent);
      transition: left 0.5s ease;
    }
    nav button:hover::before { left: 100%; }
    nav button.active {
      color: var(--accent); background: linear-gradient(135deg, rgba(0,212,255,0.2) 0%, rgba(77,243,197,0.1) 100%);
      border: 1.5px solid rgba(0,212,255,0.5);
      box-shadow: 0 0 25px rgba(0,212,255,0.2), inset 0 1px 1px rgba(255,255,255,0.1);
    }
    nav button:hover:not(.active) { background: rgba(20,40,70,0.6); border-color: rgba(0,212,255,0.3); transform: translateY(-3px); }
    nav button.hidden { display: none; }

    .page {
      display: none; max-width: 1400px; margin: 40px auto; padding: 40px;
      background: linear-gradient(135deg, rgba(20,40,70,0.5) 0%, rgba(15,30,50,0.3) 100%);
      border-radius: 20px; border: 1px solid rgba(0,212,255,0.15);
      backdrop-filter: blur(10px);
      box-shadow: 0 15px 50px rgba(0,0,0,0.4), inset 0 1px 1px rgba(255,255,255,0.05);
      animation: pageSlideIn 0.4s ease-out;
    }
    @keyframes pageSlideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .page.active { display: block; }

    .page-heading {
      display: flex; align-items: center; gap: 18px; margin-bottom: 32px;
      padding-bottom: 24px; border-bottom: 2px solid rgba(0,212,255,0.1);
    }
    .page-heading .pill {
      font-size: 11px; padding: 8px 16px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border-radius: 50px; color: #051317; font-weight: 900;
      text-transform: uppercase; letter-spacing: 1.2px;
      box-shadow: 0 4px 15px rgba(0,212,255,0.2);
    }
    .page-heading h2 {
      margin: 0; font-size: 32px; font-weight: 900; color: var(--accent);
      text-shadow: 0 0 10px rgba(0,212,255,0.15); letter-spacing: -0.5px;
    }

    .unit-health-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px; margin-bottom: 32px;
    }

    .unit-health-card {
      background: linear-gradient(135deg, rgba(20,40,70,0.6) 0%, rgba(15,30,50,0.4) 100%);
      border: 1.5px solid rgba(0,212,255,0.2); border-radius: 16px; padding: 24px;
      backdrop-filter: blur(10px); transition: all 0.3s ease;
      box-shadow: 0 10px 35px rgba(0,0,0,0.3);
      position: relative; overflow: hidden; cursor: pointer;
    }
    .unit-health-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2), transparent);
    }
    .unit-health-card:hover {
      transform: translateY(-6px);
      border-color: rgba(0,212,255,0.4);
      box-shadow: 0 15px 45px rgba(0,212,255,0.15), 0 0 20px rgba(0,212,255,0.1);
    }

    .unit-health-header {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;
    }
    .unit-health-title {
      font-size: 16px; font-weight: 900; color: var(--accent);
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .unit-health-status {
      font-size: 12px; padding: 6px 12px; border-radius: 20px; font-weight: 800;
      background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(16,185,129,0.1));
      color: #10b981; text-transform: uppercase; letter-spacing: 0.5px;
    }

    .unit-health-content {
      display: flex; flex-direction: column; gap: 12px;
    }
    .health-stat {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 12px; padding: 8px 0; border-bottom: 1px solid rgba(0,212,255,0.1);
    }
    .health-stat:last-child { border-bottom: none; }
    .health-label { color: var(--muted); font-weight: 600; }
    .health-value { color: var(--accent-2); font-weight: 700; font-size: 13px; }

    .nodes-list {
      margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,212,255,0.15);
    }
    .node-item {
      display: flex; align-items: center; justify-content: space-between;
      font-size: 11px; padding: 6px 0; color: var(--text-secondary);
      cursor: pointer; padding: 8px; border-radius: 8px; transition: all 0.2s ease;
    }
    .node-item:hover { background: rgba(0,212,255,0.1); }
    .node-name { font-weight: 700; color: var(--text); }
    .node-status {
      padding: 2px 8px; border-radius: 12px; font-weight: 700;
      background: rgba(16,185,129,0.2); color: #10b981; font-size: 10px;
    }

    .filter-controls {
      display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;
      padding: 16px; background: rgba(0,212,255,0.03); border-radius: 12px;
      border: 1px solid rgba(0,212,255,0.1);
      align-items: center;
    }
    .filter-controls select, .filter-controls input {
      padding: 10px 14px; background: rgba(0,0,0,0.3);
      border: 1px solid rgba(0,212,255,0.2); border-radius: 8px;
      color: var(--text); font-size: 12px; font-weight: 600;
      cursor: pointer; transition: all 0.3s ease;
    }
    .filter-controls select:hover, .filter-controls select:focus,
    .filter-controls input:hover, .filter-controls input:focus {
      border-color: rgba(0,212,255,0.5);
      background: rgba(0,212,255,0.05);
    }
    .filter-btn, .download-btn {
      padding: 10px 18px; background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #051317; border: none; border-radius: 8px; font-weight: 700; font-size: 12px;
      cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .filter-btn:hover, .download-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,212,255,0.2); }

    table {
      width: 100%; border-collapse: collapse; font-size: 13px; border-radius: 14px;
      overflow: hidden; background: rgba(20,40,70,0.7);
      box-shadow: 0 10px 35px rgba(0,0,0,0.3);
    }

    thead th {
      background: linear-gradient(90deg, rgba(0,212,255,0.15) 0%, rgba(77,243,197,0.08) 100%);
      color: var(--accent); font-weight: 900; padding: 18px 22px;
      text-transform: uppercase; letter-spacing: 0.8px;
      border-bottom: 2px solid rgba(0,212,255,0.2);
      position: relative;
    }
    thead th::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    }

    tbody td { padding: 16px 22px; border-bottom: 1px solid rgba(0,212,255,0.06); color: var(--text); transition: all 0.2s ease; }
    tbody tr { transition: all 0.3s ease; cursor: pointer; }
    tbody tr:hover {
      background: rgba(0,212,255,0.08);
      box-shadow: inset 0 0 15px rgba(0,212,255,0.05);
    }
    tbody tr:last-child td { border-bottom: none; }

    .state-badge {
      padding: 8px 14px; border-radius: 20px; font-weight: 800; color: white;
      display: inline-block; min-width: 120px; text-align: center; font-size: 12px;
      letter-spacing: 0.5px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      text-transform: uppercase;
    }

    .badge-EMERGENCY_OFF { background: linear-gradient(135deg, #ff4c4c, #ff6b6b); box-shadow: 0 4px 15px rgba(255,76,76,0.4); animation: pulse-badge 1.5s ease-in-out infinite; }
    @keyframes pulse-badge { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .badge-OFF { background: linear-gradient(135deg, #a75252, #c96969); }
    .badge-SAFE_MODE { background: linear-gradient(135deg, #05b8ff, #00d4ff); }
    .badge-ON { background: linear-gradient(135deg, #fbbf24, #fca311); color: #3b2800; }
    .badge-OPTIMAL { background: linear-gradient(135deg, #10b981, #059669); color: #0a2612; }
    .badge-ALERT { background: linear-gradient(135deg, #e69500, #f59e0b); }
    .badge-BACKUP_ON { background: linear-gradient(135deg, #8b5cf6, #a78bfa); }
    .badge-BACKUP_SENSOR { background: linear-gradient(135deg, #22d3ee, #06b6d4); color: #05323a; }
    .badge-AUTO_ORCHESTRATED { background: linear-gradient(135deg, #9333ea, #a855f7); color: #f5e6ff; }

    .control-btn {
      padding: 10px 18px; margin-right: 10px; border-radius: 14px; font-weight: 700; font-size: 12px;
      cursor: pointer; border: none; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .btn-on {
      background: linear-gradient(135deg, var(--success), var(--success-dark));
      color: #0a2612; box-shadow: 0 4px 15px rgba(16,185,129,0.3);
    }
    .btn-on:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16,185,129,0.4); }
    .btn-off {
      background: linear-gradient(135deg, var(--danger), var(--danger-light));
      color: #3e100e; box-shadow: 0 4px 15px rgba(255,107,107,0.3);
    }
    .btn-off:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,107,107,0.4); }
    .btn-disabled { background-color: var(--muted); color: #334455; cursor: not-allowed; opacity: 0.5; }
    .btn-loading { opacity: 0.6; pointer-events: none; }

    ul#alertsList {
      list-style: none; padding: 0; margin: 0; display: grid; gap: 16px;
    }
    ul#alertsList li {
      padding: 18px 22px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(20,40,70,0.5) 0%, rgba(15,30,50,0.3) 100%);
      border: 1.5px solid rgba(0,212,255,0.15);
      color: var(--muted); font-weight: 600; transition: all 0.3s ease;
      border-left: 4px solid rgba(0,212,255,0.3); cursor: pointer;
    }
    ul#alertsList li:hover {
      transform: translateX(8px);
      border-color: rgba(0,212,255,0.3);
      background: linear-gradient(135deg, rgba(20,40,70,0.7) 0%, rgba(15,30,50,0.5) 100%);
    }
    ul#alertsList li.alert {
      color: var(--danger); font-weight: 800; border-left: 4px solid var(--danger);
      background: rgba(255,107,107,0.05);
    }
    ul#alertsList li.action {
      color: var(--warn); font-weight: 700; border-left: 4px solid var(--warn);
      background: rgba(251,191,36,0.05);
    }

    .chart-container {
      background: linear-gradient(135deg, rgba(20,40,70,0.5) 0%, rgba(15,30,50,0.3) 100%);
      border: 1.5px solid rgba(0,212,255,0.15); border-radius: 18px; padding: 28px;
      margin-bottom: 28px; box-shadow: 0 10px 35px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    .chart-container:hover { border-color: rgba(0,212,255,0.3); box-shadow: 0 15px 45px rgba(0,212,255,0.1); }
    .chart-title {
      font-size: 16px; font-weight: 900; color: var(--accent); margin-bottom: 20px;
      text-transform: uppercase; letter-spacing: 0.8px;
    }

    .permission-notice {
      padding: 20px 24px;
      background: linear-gradient(135deg, rgba(251,191,36,0.08) 0%, rgba(251,191,36,0.04) 100%);
      border: 1.5px solid rgba(251,191,36,0.3);
      border-radius: 14px;
      color: var(--warn);
      font-weight: 600;
      text-align: center;
      margin-bottom: 24px;
      letter-spacing: 0.3px;
      box-shadow: 0 4px 15px rgba(251,191,36,0.1);
    }

    .refresh-notice {
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(0,212,255,0.08) 0%, rgba(0,212,255,0.04) 100%);
      border: 1px solid rgba(0,212,255,0.2);
      border-radius: 8px;
      color: var(--muted);
      font-weight: 600;
      text-align: center;
      margin-bottom: 16px;
      letter-spacing: 0.3px;
      font-size: 12px;
    }

    /* MODALS */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      backdrop-filter: blur(8px);
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease-out;
    }
    .modal-overlay.active { display: flex; }
    
    .modal {
      background: linear-gradient(135deg, rgba(20,40,70,0.95) 0%, rgba(15,30,50,0.9) 100%);
      border: 1.5px solid rgba(0,212,255,0.3);
      border-radius: 20px;
      padding: 40px;
      width: 90%;
      max-width: 700px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 80px rgba(0,212,255,0.3), inset 0 1px 1px rgba(255,255,255,0.1);
      animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      margin: auto;
    }

    .modal::-webkit-scrollbar { width: 6px; }
    .modal::-webkit-scrollbar-track { background: rgba(0,212,255,0.04); }
    .modal::-webkit-scrollbar-thumb { background: linear-gradient(135deg, rgba(0,212,255,0.25), rgba(77,243,197,0.25)); border-radius: 10px; }
    .modal::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, var(--accent), var(--accent-2)); }
    
    .modal-close {
      position: absolute; top: 20px; right: 20px; width: 36px; height: 36px;
      background: rgba(0,212,255,0.1); border: none; color: var(--accent);
      border-radius: 10px; font-size: 24px; cursor: pointer; transition: all 0.3s ease;
      display: flex; align-items: center; justify-content: center;
      z-index: 1001;
    }
    .modal-close:hover { background: rgba(0,212,255,0.2); transform: rotate(90deg); }

    .modal-header { font-size: 24px; font-weight: 900; color: var(--accent); margin-bottom: 24px; letter-spacing: -0.5px; }
    .modal-section { margin-bottom: 24px; }
    .modal-label { font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--muted); letter-spacing: 0.8px; margin-bottom: 8px; }
    .modal-value { font-size: 15px; font-weight: 600; color: var(--text); line-height: 1.6; }

    .node-details-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px; margin-top: 16px;
    }
    .node-detail-card {
      background: rgba(0,212,255,0.05); border: 1px solid rgba(0,212,255,0.2);
      border-radius: 12px; padding: 16px; text-align: center; cursor: pointer;
      transition: all 0.3s ease;
    }
    .node-detail-card:hover { background: rgba(0,212,255,0.1); transform: translateY(-3px); }
    .node-detail-label { font-size: 11px; color: var(--muted); font-weight: 700; text-transform: uppercase; }
    .node-detail-value { font-size: 18px; font-weight: 900; color: var(--accent-2); margin-top: 8px; }

    .alert-history-item {
      background: rgba(0,212,255,0.05); border: 1px solid rgba(0,212,255,0.2);
      border-radius: 12px; padding: 16px; margin: 12px 0; cursor: pointer;
      transition: all 0.3s ease;
    }
    .alert-history-item:hover {
      background: rgba(0,212,255,0.08);
      border-color: rgba(0,212,255,0.4);
      transform: translateX(4px);
    }
    .alert-history-time { font-size: 12px; color: var(--muted); font-weight: 700; }
    .alert-history-status { font-size: 12px; font-weight: 700; margin-top: 6px; }
    .alert-status-resolved { color: #10b981; }
    .alert-status-active { color: #ff6b6b; }

    .action-tracked {
      background: rgba(77,243,197,0.1); border: 1px solid rgba(77,243,197,0.3);
      border-radius: 12px; padding: 16px; margin-top: 16px;
    }
    .action-tracked strong { color: var(--accent-2); display: block; margin-bottom: 8px; }
    .action-timer { font-size: 13px; color: var(--warn); font-weight: 700; margin-top: 8px; }

    .linked-units-section {
      background: rgba(0,212,255,0.05); border: 1px solid rgba(0,212,255,0.2);
      border-radius: 12px; padding: 16px; margin: 16px 0;
    }
    .linked-unit-item {
      background: rgba(0,0,0,0.2); border: 1px solid rgba(0,212,255,0.1);
      border-radius: 10px; padding: 12px; margin: 8px 0;
      font-size: 12px;
    }
    .linked-unit-name { font-weight: 900; color: var(--accent); margin-bottom: 4px; }
    .linked-unit-action { color: var(--accent-2); font-weight: 700; margin: 4px 0; }
    .linked-unit-severity { color: var(--warn); font-size: 11px; margin: 4px 0; }
    .linked-unit-status { display: inline-block; padding: 2px 8px; border-radius: 12px; font-weight: 700; font-size: 10px; }
    .linked-unit-status.success { background: rgba(16,185,129,0.3); color: #10b981; }
    .linked-unit-status.pending { background: rgba(251,191,36,0.3); color: #fbbf24; }
    .linked-unit-status.failed { background: rgba(255,107,107,0.3); color: #ff6b6b; }

    .nodes-modal {
      max-width: 800px;
    }

    .nodes-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px; margin-top: 16px;
    }

    .node-card {
      background: rgba(0,212,255,0.08); border: 1.5px solid rgba(0,212,255,0.2);
      border-radius: 14px; padding: 16px; text-align: center; cursor: pointer;
      transition: all 0.3s ease;
    }

    .node-card:hover {
      background: rgba(0,212,255,0.12);
      border-color: rgba(0,212,255,0.4);
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,212,255,0.15);
    }

    .node-card-name { font-size: 14px; font-weight: 900; color: var(--accent); margin-bottom: 8px; }
    .node-card-stat { font-size: 11px; color: var(--muted); margin: 4px 0; }
    .node-card-status { font-size: 11px; font-weight: 700; color: var(--accent-2); margin-top: 8px; padding: 4px 8px; background: rgba(77,243,197,0.2); border-radius: 6px; display: inline-block; }

    .nodes-list-items {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 16px;
    }

    .alerts-list-modal {
      display: grid; gap: 12px; margin-top: 16px;
    }

    .alert-item-modal {
      background: rgba(0,212,255,0.05); border-left: 4px solid rgba(255,107,107,0.5);
      border-radius: 10px; padding: 14px; cursor: pointer;
      transition: all 0.3s ease;
    }

    .alert-item-modal:hover {
      background: rgba(0,212,255,0.08);
      transform: translateX(4px);
      border-left-color: rgba(255,107,107,0.8);
    }

    .alert-time-modal { font-size: 11px; color: var(--muted); font-weight: 700; }
    .alert-text-modal { font-size: 13px; color: var(--text); font-weight: 600; margin: 6px 0; }
    .alert-severity-modal { font-size: 11px; font-weight: 700; display: inline-block; padding: 2px 8px; border-radius: 12px; }

    footer {
      text-align: center; padding: 32px 40px; margin-top: 80px; font-size: 12px;
      color: var(--muted); border-top: 1px solid rgba(0,212,255,0.1); letter-spacing: 0.3px;
    }

    .notification {
      position: fixed; bottom: 30px; right: 30px; z-index: 2000;
      background: linear-gradient(135deg, rgba(77,243,197,0.2), rgba(16,185,129,0.1));
      border: 1.5px solid rgba(16,185,129,0.4);
      border-radius: 14px; padding: 18px 24px;
      color: var(--accent-2); font-weight: 700; font-size: 13px;
      box-shadow: 0 10px 40px rgba(16,185,129,0.2);
      animation: slideInNotif 0.4s ease-out;
      max-width: 300px;
    }
    .notification.error {
      background: linear-gradient(135deg, rgba(255,107,107,0.2), rgba(255,76,76,0.1));
      border-color: rgba(255,107,107,0.4);
      color: #ff6b6b;
      box-shadow: 0 10px 40px rgba(255,107,107,0.2);
    }
    @keyframes slideInNotif { from { opacity: 0; transform: translateX(400px); } to { opacity: 1; transform: translateX(0); } }

    @media (max-width: 1200px) {
      .login-container { flex-direction: column; gap: 30px; }
      .login-section { flex: none; width: 100%; }
    }
    @media (max-width: 900px) {
      header { padding: 14px 20px; flex-wrap: wrap; }
      nav { padding: 16px 20px; gap: 8px; }
      .page { margin: 20px; padding: 24px; }
      .modal { max-width: 90%; padding: 24px; }
      .unit-health-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
      .alert-split { grid-template-columns: 1fr; }
      .filter-controls { flex-direction: column; }
    }
    @media (max-width: 600px) {
      header { flex-direction: column; gap: 12px; }
      .header-stats { flex-direction: column; width: 100%; }
      .page { margin: 16px; padding: 16px; }
      .stats-grid { grid-template-columns: 1fr; }
      .modal { padding: 20px; }
      .unit-health-grid { grid-template-columns: 1fr; }
      .node-details-grid { grid-template-columns: 1fr; }
      .nodes-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <!-- LOGIN OVERLAY -->
  <div class="login-overlay active" id="loginOverlay">
    <div class="login-container">
      <div class="login-section">
        <div class="login-branding">
          <h1>ZyroEdge</h1>
          <p>Enterprise Industrial IoT Platform</p>
        </div>
        <div class="login-features">
          <div class="feature-item">
            <div class="feature-icon">üìä</div>
            <div class="feature-text">
              <strong>Real-time Monitoring</strong>
              <span>Live sensor data with millisecond precision</span>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">üîî</div>
            <div class="feature-text">
              <strong>Intelligent Alerts</strong>
              <span>AI-powered anomaly detection system</span>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">üë•</div>
            <div class="feature-text">
              <strong>Role-Based Access</strong>
              <span>Fine-grained permissions & audit trails</span>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">üìà</div>
            <div class="feature-text">
              <strong>Advanced Analytics</strong>
              <span>Predictive insights & trend forecasting</span>
            </div>
          </div>
        </div>
      </div>
      <div class="login-section">
        <div class="login-box">
          <div class="login-header">
            <div class="login-logo">
              <img src="https://github.com/Prathaamm/zyroedgeassets/raw/fa50f43440b85cc0c4b72075ed26defaf628bfa3/logo.png" alt="ZyroEdge Logo">
            </div>
            <h1>Sign In</h1>
            <p>Secure Access Portal</p>
          </div>
          <form class="login-form" id="loginForm">
            <div class="form-group">
              <label class="form-label">Username</label>
              <input type="text" class="form-input" id="loginUsername" placeholder="username@zyroedge" required />
            </div>
            <div class="form-group">
              <label class="form-label">Password</label>
              <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
            </div>
            <button type="submit" class="login-btn">Enter Dashboard</button>
            <div class="login-error" id="loginError"></div>
            <div style="text-align: center; margin-top: 20px;">
              <button type="button" class="switch-form-btn" onclick="showRegistrationForm()">
                Don't have an account? <strong>Register Now</strong>
              </button>
            </div>
            <!-- <div class="login-info">
              <strong>üìù Demo Accounts:</strong><br>
              plant_manager@zyroedge ‚Ä¢ operator@zyroedge ‚Ä¢ maintenance@zyroedge<br>
              <strong>Password:</strong> password
            </div> -->
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- REGISTRATION OVERLAY -->
  <div class="registration-overlay" id="registrationOverlay">
    <div class="login-container">
      <div class="login-section">
        <div class="login-branding">
          <h1>ZyroEdge</h1>
          <p>Create Your Account</p>

        </div>
        <div class="login-features">
          <div class="feature-item">
            <div class="feature-icon">‚ú®</div>
            <div class="feature-text">
              <strong>Quick Registration</strong>
              <span>Get started in less than 2 minutes</span>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">üîê</div>
            <div class="feature-text">
              <strong>Secure Access</strong>
              <span>Your credentials are encrypted and protected</span>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">üë•</div>
            <div class="feature-text">
              <strong>Role-Based System</strong>
              <span>Access levels tailored to your responsibilities</span>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">‚ö°</div>
            <div class="feature-text">
              <strong>Instant Activation</strong>
              <span>Start monitoring immediately after signup</span>
            </div>
          </div>
        </div>
      </div>
      <div class="login-section">
        <div class="login-box">
          <div class="login-header">
            <div class="login-logo">
              <img src="https://github.com/Prathaamm/zyroedgeassets/raw/fa50f43440b85cc0c4b72075ed26defaf628bfa3/logo.png" alt="ZyroEdge Logo">
            </div>
            <h1>Register</h1>
            <p>Join ZyroEdge Platform</p>
          </div>
          <form class="login-form" id="registrationForm">
            <div class="form-group">
              <label class="form-label">Full Name</label>
              <input type="text" class="form-input" id="regFullName" placeholder="John Doe" required />
            </div>
            <div class="form-group">
              <label class="form-label">Email Address</label>
              <input type="email" class="form-input" id="regEmail" placeholder="john.doe@company.com" required />
            </div>
            <div class="form-group">
              <label class="form-label">Username</label>
              <input type="text" class="form-input" id="regUsername" placeholder="johndoe@zyroedge" required />
              <span style="font-size: 10px; color: var(--muted); margin-top: 4px; display: block;">Must end with @zyroedge</span>
            </div>
            <div class="form-group">
              <label class="form-label">Password</label>
              <input type="password" class="form-input" id="regPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6" />
            </div>
            <div class="form-group">
              <label class="form-label">Confirm Password</label>
              <input type="password" class="form-input" id="regConfirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6" />
            </div>
            <div class="form-group">
              <label class="form-label">Access Role</label>
              <select class="form-input" id="regRole" required style="cursor: pointer;">
                <option value="">Select Role</option>
                <option value="plant_manager">Plant Manager (Full Access)</option>
                <option value="maintenance">Maintenance Engineer</option>
                <option value="operator">Operator (Unit-Specific)</option>
                <option value="diagnostics">Diagnostics Specialist</option>
                <option value="auditor">Auditor (Read-Only)</option>
              </select>
            </div>
            <div class="form-group" id="operatorUnitSelection" style="display: none;">
              <label class="form-label">Assigned Unit (Operators Only)</label>
              <select class="form-input" id="regOperatorUnit">
                <option value="UNIT-A">UNIT-A</option>
                <option value="UNIT-B">UNIT-B</option>
                <option value="UNIT-C">UNIT-C</option>
                <option value="UNIT-D">UNIT-D</option>
                <option value="UNIT-E">UNIT-E</option>
              </select>
            </div>
            <button type="submit" class="login-btn">Create Account</button>
            <div class="login-error" id="registrationError"></div>
            <div style="text-align: center; margin-top: 20px;">
              <button type="button" class="switch-form-btn" onclick="showLoginForm()">
                Already have an account? <strong>Sign In</strong>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header>
    <div class="brand">
      <div class="logo">
        <img src="https://github.com/Prathaamm/zyroedgeassets/raw/fa50f43440b85cc0c4b72075ed26defaf628bfa3/logo.png" alt="ZyroEdge Logo">
      </div>
      <div>
        <h1>ZyroEdge</h1>
        <div class="tagline">Enterprise IoT Intelligence Platform</div>
      </div>
    </div>
    <div class="header-stats">
      <div class="header-info">
        <span>üë§</span>
        <span class="role-value" id="headerRole">‚Äî</span>
      </div>
      <div class="unit-selector" id="unitSelectorWrapper">
        <label for="unitSelector">üìç Unit</label>
        <select id="unitSelector">
          <option value="">All Units</option>
          <option value="UNIT-A">UNIT-A</option>
          <option value="UNIT-B">UNIT-B</option>
          <option value="UNIT-C">UNIT-C</option>
          <option value="UNIT-D">UNIT-D</option>
          <option value="UNIT-E">UNIT-E</option>
          <option value="UNIT-F">UNIT-F</option>
        </select>
      </div>
      <div id="status">üîÑ Connecting...</div>
      <div id="systemHealth" class="safe">üü¢ OPTIMAL</div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <!-- HERO SECTION -->
  <div id="heroSection">
    <h2>Welcome to ZyroEdge</h2>
    <p id="roleDescription">Enterprise-grade Industrial IoT Monitoring & Analytics</p>
    <div class="stats-grid">
      <div class="stat-card" onclick="showNodesModal();" style="cursor: pointer;">
        <span class="stat-icon">üìä</span>
        <span class="stat-label">Active Nodes</span>
        <span class="stat-value" id="activeNodes">-</span>
      </div>
      
      <div class="stat-card"><span class="stat-icon">‚ö°</span><span class="stat-label">Total Records</span><span class="stat-value" id="dataPoints">-</span></div>
      
      <div class="alert-split">
        <div class="alert-stat-card active" onclick="showActiveAlertsModal();" style="cursor: pointer;">
          <span class="alert-label">üî¥ Active (< 10 min)</span>
          <span class="alert-value" id="activeAlerts">0</span>
          <span class="alert-badge">Recent</span>
        </div>
        <div class="alert-stat-card solved" onclick="showSolvedAlertsModal();" style="cursor: pointer;">
          <span class="alert-label">‚úÖ Solved</span>
          <span class="alert-value" id="solvedAlerts">0</span>
          <span class="alert-badge">Resolved</span>
        </div>
      </div>

      <div class="time-card" onclick="showTimeDetailsModal();" style="cursor: pointer;">
        <span class="time-label">üïê Latest Update</span>
        <span class="time-display" id="lastUpdateTime">-</span>
        <span class="time-date" id="lastUpdateDate">-</span>
      </div>
    </div>
  </div>

  <!-- NAVIGATION -->
  <nav id="mainNav">
    <button class="tab-btn active" data-page="overview" data-roles="plant_manager,maintenance,diagnostics">üìä Overview</button>
    <button class="tab-btn" data-page="liveData" data-roles="plant_manager,maintenance,operator">üì° Live Data</button>
    <button class="tab-btn" data-page="graphs" data-roles="plant_manager,diagnostics">üìà Trends</button>
    <button class="tab-btn" data-page="actuators" data-roles="plant_manager,maintenance">‚öôÔ∏è Control Unit</button>
    <button class="tab-btn" data-page="alerts" data-roles="plant_manager,maintenance,operator">üîî Alerts</button>
    <button class="tab-btn" data-page="history" data-roles="plant_manager,maintenance,diagnostics,auditor">üìú History</button>
  </nav>

  <!-- OVERVIEW PAGE -->
  <div id="overview" class="page active">
    <div class="page-heading">
      <div class="pill">Dashboard</div>
      <h2>System Overview</h2>
    </div>

    <div class="unit-health-grid" id="unitHealthGrid"></div>

    <table id="overviewTable">
      <thead>
        <tr>
          <th>Unit</th><th>Node</th><th>Status</th><th>pH</th><th>TDS (ppm)</th><th>Temp (¬∞C)</th><th>Last Seen</th><th>Overall</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- LIVE DATA PAGE -->
  <div id="liveData" class="page">
    <div class="page-heading">
      <div class="pill">Real-Time</div>
      <h2>Live Telemetry Stream</h2>
    </div>
    <div id="operatorNotice" class="permission-notice" style="display:none;">
      üìç Operator: Unit filter enabled. Use the Unit dropdown (top-right).
    </div>
    <table id="liveDataTable">
      <thead>
        <tr>
          <th>Time</th><th>Unit</th><th>Node</th><th>pH</th><th>TDS (ppm)</th><th>Temp (¬∞C)</th><th>Flow (LPM)</th><th>Pressure (bar)</th><th>Level (%)</th><th>Severity</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- GRAPHS PAGE -->
  <div id="graphs" class="page">
    <div class="page-heading">
      <div class="pill">Analytics</div>
      <h2>Sensor Trend Analysis</h2>
    </div>
    <div class="chart-container">
      <div class="chart-title">üìä pH Level Monitoring</div>
      <canvas id="phChart" height="80"></canvas>
    </div>
    <div class="chart-container">
      <div class="chart-title">üíß TDS Concentration</div>
      <canvas id="tdsChart" height="80"></canvas>
    </div>
    <div class="chart-container">
      <div class="chart-title">üå°Ô∏è Temperature Tracking</div>
      <canvas id="tempChart" height="80"></canvas>
    </div>
  </div>

  <!-- ACTUATORS PAGE -->
  <div id="actuators" class="page">
    <div class="page-heading">
      <div class="pill">Control</div>
      <h2>Actuator Management</h2>
    </div>
    <div id="maintenanceNotice" class="permission-notice" style="display:none;">
      üîß Maintenance: Full control enabled. Commands will be orchestrated across linked units.
    </div>
    <table id="actuatorTable">
      <thead>
        <tr>
          <th>Time</th><th>Unit</th><th>Node</th><th>State</th><th>Action</th><th>Vibration (RMS)</th><th>Controls</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ALERTS PAGE -->
  <div id="alerts" class="page">
    <div class="page-heading">
      <div class="pill">Critical</div>
      <h2>Active Alerts & Events</h2>
    </div>
    <ul id="alertsList"></ul>
  </div>

  <!-- HISTORY PAGE -->
  <div id="history" class="page">
    <div class="page-heading">
      <div class="pill">Archive</div>
      <h2>Complete History & Incidents</h2>
    </div>
    <div class="refresh-notice">
      üí° Auto-refresh paused. Use filters below and click Reload to apply.
    </div>
    <div class="filter-controls">
      <label style="font-size:12px;color:var(--muted);font-weight:700;">Severity</label>
      <select id="historySeverityFilter">
        <option value="">All</option>
        <option value="CRITICAL">CRITICAL</option>
        <option value="HIGH">HIGH</option>
        <option value="MEDIUM">MEDIUM</option>
        <option value="LOW">LOW</option>
        <option value="INFO">INFO</option>
      </select>
      
      <label style="font-size:12px;color:var(--muted);font-weight:700;">Limit</label>
      <select id="historyLimitFilter">
        <option value="50">50 Records</option>
        <option value="100">100 Records</option>
        <option value="200">200 Records</option>
        <option value="500">500 Records</option>
        <option value="10000">All Records</option>
      </select>
      
      <button class="filter-btn" onclick="applyHistoryFilters()">üîÑ Reload</button>
      <button class="download-btn" id="downloadReportBtn" onclick="downloadFilteredReport()" style="display:none;">üì• Download</button>
    </div>
    <table id="historyTable">
      <thead>
        <tr>
          <th>Time</th><th>Unit</th><th>Node</th><th>Severity</th><th>Overall</th><th>Alert</th><th>Command Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- NODES MODAL -->
  <div class="modal-overlay" id="nodesModal" onclick="if(event.target === this) closeModal('nodesModal')">
    <div class="modal nodes-modal">
      <button class="modal-close" onclick="closeModal('nodesModal')">‚úï</button>
      <div class="modal-header">üìä All Active Nodes</div>
      
      <div class="modal-section">
        <div class="modal-label">Node List</div>
        <div class="nodes-grid" id="nodesGrid"></div>
      </div>
    </div>
  </div>

  <!-- ACTIVE ALERTS MODAL -->
  <div class="modal-overlay" id="activeAlertsModal" onclick="if(event.target === this) closeModal('activeAlertsModal')">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('activeAlertsModal')">‚úï</button>
      <div class="modal-header">üî¥ Active Alerts (< 10 minutes)</div>
      
      <div class="modal-section">
        <div class="alerts-list-modal" id="activeAlertsList"></div>
      </div>
    </div>
  </div>

  <!-- SOLVED ALERTS MODAL -->
  <div class="modal-overlay" id="solvedAlertsModal" onclick="if(event.target === this) closeModal('solvedAlertsModal')">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('solvedAlertsModal')">‚úï</button>
      <div class="modal-header">‚úÖ Solved Alerts (> 10 minutes)</div>
      
      <div class="modal-section">
        <div class="alerts-list-modal" id="solvedAlertsList"></div>
      </div>
    </div>
  </div>

  <!-- TIME DETAILS MODAL -->
  <div class="modal-overlay" id="timeDetailsModal" onclick="if(event.target === this) closeModal('timeDetailsModal')">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('timeDetailsModal')">‚úï</button>
      <div class="modal-header">üïê Latest Data Details</div>
      
      <div class="modal-section">
        <div class="modal-label">Last Update Timestamp</div>
        <div class="modal-value" id="timeDetailsContent">-</div>
      </div>
      
      <div class="modal-section">
        <div class="modal-label">Recent Records (Last 10)</div>
        <div id="recentRecordsList" style="margin-top: 12px;"></div>
      </div>
    </div>
  </div>

  <!-- UNIT DETAILS MODAL -->
  <div class="modal-overlay" id="unitDetailsModal" onclick="if(event.target === this) closeModal('unitDetailsModal')">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('unitDetailsModal')">‚úï</button>
      <div class="modal-header">üìä Unit Details & Node Statistics</div>
      
      <div class="modal-section">
        <div class="modal-label">Unit Name</div>
        <div class="modal-value" id="modalUnitName">-</div>
      </div>

      <div class="modal-section">
        <div class="modal-label">Node Details</div>
        <div class="node-details-grid" id="nodeDetailsGrid"></div>
      </div>

      <div class="modal-section">
        <div class="modal-label">Alert History</div>
        <div id="alertHistoryList"></div>
      </div>
    </div>
  </div>

  <!-- ALERT RESOLUTION MODAL -->
  <div class="modal-overlay" id="alertResolutionModal" onclick="if(event.target === this) closeModal('alertResolutionModal')">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('alertResolutionModal')">‚úï</button>
      <div class="modal-header">üîî Alert Resolution Details</div>
      
      <div class="modal-section">
        <div class="modal-label">Alert</div>
        <div class="modal-value" id="resolutionAlertText">-</div>
      </div>

      <div class="modal-section">
        <div class="modal-label">Issue</div>
        <div class="modal-value" id="resolutionIssue">-</div>
      </div>

      <div class="modal-section">
        <div class="modal-label">Node Information</div>
        <div style="font-size: 13px; color: var(--text); margin-top: 8px;">
          <span style="display: block; margin: 4px 0;">Unit: <strong id="resolutionUnit">-</strong></span>
          <span style="display: block; margin: 4px 0;">Node: <strong id="resolutionNode">-</strong></span>
        </div>
      </div>

      <div class="modal-section">
        <div class="modal-label">Action Taken</div>
        <div class="modal-value" id="resolutionAction">-</div>
      </div>

      <div class="modal-section">
        <div class="modal-label">Resolution Status</div>
        <div id="resolutionStatus" style="font-size: 14px; font-weight: 700; margin-top: 8px;"></div>
      </div>

      <div class="modal-section">
        <div class="modal-label">Timestamp & Duration</div>
        <div class="modal-value">
          <span style="display: block; margin: 4px 0;">Started: <strong id="resolutionStartTime">-</strong></span>
          <span style="display: block; margin: 4px 0;">Resolved: <strong id="resolutionEndTime">-</strong></span>
          <span style="display: block; margin: 4px 0;">Duration: <strong id="resolutionDuration">-</strong></span>
        </div>
      </div>

      <div class="modal-section">
        <div class="modal-label">Linked Unit Dependencies</div>
        <div class="linked-units-section" id="linkedUnitsSection" style="display:none;">
          <div id="linkedUnitsList"></div>
        </div>
        <div style="color: var(--muted); font-size: 12px; margin-top: 8px; font-style: italic; display:none;" id="noLinkedUnitsMsg">
          No linked units for this alert
        </div>
      </div>

      <div id="actionTracked" class="action-tracked" style="display:none;">
        <strong>‚è±Ô∏è Action Being Tracked</strong>
        <div class="action-timer" id="actionTimer"></div>
        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 6px;">If issue persists after 5 min, notification will be triggered</div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>¬© 2025 ZyroEdge ‚Ä¢ Enterprise Industrial IoT Monitoring Platform ‚Ä¢ v7.4</footer>

  <script>
    const API_ENDPOINT = "https://zfplft8juj.execute-api.us-east-1.amazonaws.com/prod/iotdata";
    const ACTIVE_ALERT_WINDOW = 10 * 60 * 1000; // 10 minutes
    const ACTION_TIMEOUT = 5 * 60 * 1000;
    
    const rolePermissions = {
      plant_manager: {
        sections: ['overview','liveData','graphs','actuators','alerts','history'],
        alertFilter: (row) => row["Alert"] && row["Alert"].trim() !== "",
        canControl: true,
        canDownload: true,
        description: "Enterprise administrator with complete system access"
      },
      maintenance: {
        sections: ['overview','liveData','actuators','alerts','history'],
        alertFilter: (row) => ["HIGH","CRITICAL"].includes((row["Severity"] || "").toUpperCase()),
        canControl: true,
        canDownload: false,
        description: "Maintenance specialist with equipment control authority"
      },
      operator: {
        sections: ['liveData','alerts'],
        alertFilter: (row) => ["LOW","MEDIUM","HIGH","CRITICAL"].includes((row["Severity"] || "").toUpperCase()),
        canControl: true,
        unitRestricted: true,
        canDownload: false,
        description: "Unit operator with multi-unit monitoring access"
      },
      diagnostics: {
        sections: ['overview','graphs','history'],
        alertFilter: (row) => {
          const alert = (row["Alert"] || "").toUpperCase();
          return alert.includes("OFFLINE") || alert.includes("STUCK") || alert.includes("DEGRADED") || alert.includes("SENSOR");
        },
        canControl: false,
        canDownload: false,
        description: "Diagnostics specialist with read-only system analysis"
      },
      auditor: {
        sections: ['history'],
        alertFilter: () => false,
        canControl: false,
        canDownload: true,
        description: "Compliance auditor with historical log access"
      }
    };

    let currentRole = '', assignedUnit = '', isLoggedIn = false;
    let fullHistoryData = [];
    let allData = [];
    let autoRefreshInterval = null;
    let isOnHistoryPage = false;
    let currentFilteredHistoryData = [];
    const phData = [], tdsData = [], tempData = [], timeLabels = [];
    const statusEl = document.getElementById("status");
    const systemHealthEl = document.getElementById("systemHealth");
    const actuatorStates = {};
    const actionTimers = {};

    const actuatorStateInfo = {
      "EMERGENCY_OFF": { display: "Emergency Off", className: "badge-EMERGENCY_OFF" },
      "OFF": { display: "Off", className: "badge-OFF" },
      "SAFE_MODE": { display: "Safe Mode", className: "badge-SAFE_MODE" },
      "ON": { display: "On", className: "badge-ON" },
      "OPTIMAL": { display: "Optimal", className: "badge-OPTIMAL" },
      "ALERT": { display: "Alert", className: "badge-ALERT" },
      "BACKUP_ON": { display: "Backup Motor", className: "badge-BACKUP_ON" },
      "BACKUP_SENSOR": { display: "Backup Sensor", className: "badge-BACKUP_SENSOR" },
      "AUTO": { display: "Auto", className: "badge-AUTO_ORCHESTRATED" },
      "MAINTENANCE": { display: "Maintenance", className: "badge-OFF" }
    };

    const chartOptions = {
      responsive: true, maintainAspectRatio: true,
      plugins: { legend: { labels: { color: "#8ba3b8", font: { size: 12, weight: '700' }, padding: 16 } } },
      scales: {
        x: { ticks: { color: "#8ba3b8", font: { size: 11, weight: '600' } }, grid: { color: "rgba(0,212,255,0.05)" } },
        y: { ticks: { color: "#8ba3b8", font: { size: 11, weight: '600' } }, grid: { color: "rgba(0,212,255,0.05)" } }
      }
    };

    const phChart = new Chart(document.getElementById("phChart"), {
      type: "line",
      data: { labels: timeLabels, datasets: [{ label: "pH Level", data: phData, borderColor: "#00d4ff", backgroundColor: "rgba(0,212,255,0.1)", fill: true, tension: 0.4, pointRadius: 4, borderWidth: 3, pointBackgroundColor: "#00d4ff", pointBorderColor: "#fff", pointBorderWidth: 2 }] },
      options: chartOptions
    });
    const tdsChart = new Chart(document.getElementById("tdsChart"), {
      type: "line",
      data: { labels: timeLabels, datasets: [{ label: "TDS (ppm)", data: tdsData, borderColor: "#4df3c5", backgroundColor: "rgba(77,243,197,0.1)", fill: true, tension: 0.4, pointRadius: 4, borderWidth: 3, pointBackgroundColor: "#4df3c5", pointBorderColor: "#fff", pointBorderWidth: 2 }] },
      options: chartOptions
    });
    const tempChart = new Chart(document.getElementById("tempChart"), {
      type: "line",
      data: { labels: timeLabels, datasets: [{ label: "Temperature (¬∞C)", data: tempData, borderColor: "#fbbf24", backgroundColor: "rgba(251,191,36,0.1)", fill: true, tension: 0.4, pointRadius: 4, borderWidth: 3, pointBackgroundColor: "#fbbf24", pointBorderColor: "#fff", pointBorderWidth: 2 }] },
      options: chartOptions
    });

    // USER MANAGEMENT WITH LOCALSTORAGE
    function initializeUsers() {
      if (!localStorage.getItem('zyroedge_users')) {
        const defaultUsers = {
          'plant_manager@zyroedge': {
            password: 'password',
            role: 'plant_manager',
            fullName: 'Plant Manager',
            email: 'manager@zyroedge.com',
            assignedUnit: ''
          },
          'operator@zyroedge': {
            password: 'password',
            role: 'operator',
            fullName: 'Operator',
            email: 'operator@zyroedge.com',
            assignedUnit: 'UNIT-A'
          },
          'maintenance@zyroedge': {
            password: 'password',
            role: 'maintenance',
            fullName: 'Maintenance Engineer',
            email: 'maintenance@zyroedge.com',
            assignedUnit: ''
          },
          'diagnostics@zyroedge': {
            password: 'password',
            role: 'diagnostics',
            fullName: 'Diagnostics Specialist',
            email: 'diagnostics@zyroedge.com',
            assignedUnit: ''
          },
          'auditor@zyroedge': {
            password: 'password',
            role: 'auditor',
            fullName: 'Auditor',
            email: 'auditor@zyroedge.com',
            assignedUnit: ''
          }
        };
        localStorage.setItem('zyroedge_users', JSON.stringify(defaultUsers));
      }
    }

    function getUsers() {
      return JSON.parse(localStorage.getItem('zyroedge_users') || '{}');
    }

    function saveUser(username, userData) {
      const users = getUsers();
      users[username] = userData;
      localStorage.setItem('zyroedge_users', JSON.stringify(users));
    }

    function showRegistrationForm() {
      document.getElementById('loginOverlay').classList.remove('active');
      document.getElementById('registrationOverlay').classList.add('active');
    }

    function showLoginForm() {
      document.getElementById('registrationOverlay').classList.remove('active');
      document.getElementById('loginOverlay').classList.add('active');
    }

    // Initialize users on page load
    initializeUsers();

    // REGISTRATION FORM HANDLER
    document.getElementById('regRole').addEventListener('change', (e) => {
      const operatorUnitDiv = document.getElementById('operatorUnitSelection');
      if (e.target.value === 'operator') {
        operatorUnitDiv.style.display = 'block';
      } else {
        operatorUnitDiv.style.display = 'none';
      }
    });

    document.getElementById('registrationForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const fullName = document.getElementById('regFullName').value.trim();
      const email = document.getElementById('regEmail').value.trim().toLowerCase();
      const username = document.getElementById('regUsername').value.trim().toLowerCase();
      const password = document.getElementById('regPassword').value;
      const confirmPassword = document.getElementById('regConfirmPassword').value;
      const role = document.getElementById('regRole').value;
      const operatorUnit = document.getElementById('regOperatorUnit').value;
      const errorEl = document.getElementById('registrationError');

      // Validation
      if (!username.endsWith('@zyroedge')) {
        errorEl.innerHTML = '‚ùå Username must end with @zyroedge';
        errorEl.classList.add('show');
        return;
      }

      if (password !== confirmPassword) {
        errorEl.innerHTML = '‚ùå Passwords do not match';
        errorEl.classList.add('show');
        return;
      }

      if (password.length < 6) {
        errorEl.innerHTML = '‚ùå Password must be at least 6 characters';
        errorEl.classList.add('show');
        return;
      }

      if (!role) {
        errorEl.innerHTML = '‚ùå Please select an access role';
        errorEl.classList.add('show');
        return;
      }

      // Check if user already exists
      const users = getUsers();
      if (users[username]) {
        errorEl.innerHTML = '‚ùå Username already exists. Please choose another.';
        errorEl.classList.add('show');
        return;
      }

      // Save new user
      const userData = {
        password: password,
        role: role,
        fullName: fullName,
        email: email,
        assignedUnit: role === 'operator' ? operatorUnit : '',
        createdAt: new Date().toISOString()
      };

      saveUser(username, userData);

      // Show success notification
      showNotification(`‚úÖ Account created successfully! Welcome, ${fullName}!`);
      
      // Clear form
      document.getElementById('registrationForm').reset();
      errorEl.classList.remove('show');

      // Switch to login form after 2 seconds
      setTimeout(() => {
        showLoginForm();
        document.getElementById('loginUsername').value = username;
        showNotification('You can now log in with your credentials');
      }, 2000);
    });

    // LOGIN
    document.getElementById("loginForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const username = document.getElementById("loginUsername").value.trim().toLowerCase();
      const password = document.getElementById("loginPassword").value;
      const errorEl = document.getElementById("loginError");

      const emailParts = username.split("@");
      if (emailParts.length !== 2 || emailParts[1] !== "zyroedge") {
        errorEl.innerHTML = "‚ùå Invalid username format. Use: username@zyroedge";
        errorEl.classList.add("show");
        return;
      }

      // Check against stored users
      const users = getUsers();
      
      if (!users[username]) {
        errorEl.innerHTML = "‚ùå User not found. Please register first.";
        errorEl.classList.add("show");
        return;
      }

      const userData = users[username];

      if (userData.password !== password) {
        errorEl.innerHTML = "‚ùå Incorrect password. Please try again.";
        errorEl.classList.add("show");
        return;
      }

      // Successful login
      currentRole = userData.role;
      isLoggedIn = true;
      
      // Set assigned unit for operators
      if (userData.assignedUnit) {
        assignedUnit = userData.assignedUnit;
      }
      
      errorEl.classList.remove("show");
      document.getElementById("loginOverlay").classList.remove("active");
      
      // Welcome message with user's name
      showNotification(`‚úÖ Welcome back, ${userData.fullName}!`);
      
      updateUIForRole();
      fetchDashboardData();
      autoRefreshInterval = setInterval(() => {
        if (!isOnHistoryPage) {
          fetchDashboardData();
        }
      }, 5000);
    });

    function logout() {
      isLoggedIn = false;
      currentRole = '';
      assignedUnit = '';
      fullHistoryData = [];
      allData = [];
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
      Object.values(actionTimers).forEach(timer => clearTimeout(timer));
      document.getElementById("loginOverlay").classList.add("active");
      document.getElementById("loginForm").reset();
      document.getElementById("loginError").classList.remove("show");
    }

    function updateUIForRole() {
      const perms = rolePermissions[currentRole];
      document.getElementById("headerRole").textContent = currentRole.replace('_', ' ').toUpperCase();
      document.getElementById("roleDescription").textContent = perms.description;
      
      const unitWrapper = document.getElementById("unitSelectorWrapper");
      if (perms.unitRestricted) {
        unitWrapper.classList.add("show");
        if (!assignedUnit) assignedUnit = 'UNIT-A';
        document.getElementById("unitSelector").value = assignedUnit;
      } else {
        unitWrapper.classList.remove("show");
        assignedUnit = '';
      }
     
      document.querySelectorAll('.tab-btn').forEach(btn => {
        const page = btn.dataset.page;
        btn.classList.toggle('hidden', !perms.sections.includes(page));
      });
     
      const firstVisible = document.querySelector('.tab-btn:not(.hidden)');
      if (firstVisible) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        firstVisible.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(firstVisible.dataset.page).classList.add('active');
      }
     
      document.getElementById("operatorNotice").style.display = currentRole === 'operator' ? 'block' : 'none';
      document.getElementById("maintenanceNotice").style.display = currentRole === 'maintenance' ? 'block' : 'none';
      
      const canDownload = perms.canDownload;
      document.getElementById("downloadReportBtn").style.display = canDownload ? 'inline-block' : 'none';
    }

    document.querySelectorAll("nav button").forEach(button => {
      button.addEventListener("click", () => {
        document.querySelectorAll("nav button").forEach(btn => btn.classList.remove("active"));
        button.classList.add("active");
        const pageId = button.dataset.page;
        document.querySelectorAll(".page").forEach(page => page.classList.remove("active"));
        document.getElementById(pageId).classList.add("active");
        
        isOnHistoryPage = (pageId === 'history');
      });
    });

    document.getElementById("unitSelector").addEventListener("change", (e) => {
      assignedUnit = e.target.value;
      updateAllTables();
    });

    // MODAL FUNCTIONS
    function openModal(modalId) {
      document.getElementById(modalId).classList.add("active");
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove("active");
    }

    function showNotification(message, isError = false) {
      const notif = document.createElement("div");
      notif.className = `notification ${isError ? 'error' : ''}`;
      notif.textContent = message;
      document.body.appendChild(notif);
      
      setTimeout(() => notif.remove(), 4000);
    }

    // NODES MODAL
    function showNodesModal() {
      const uniqueNodes = [...new Set(allData.map(r => r["Node"] || r["Device_id"]))];
      const nodesGrid = document.getElementById("nodesGrid");
      nodesGrid.innerHTML = "";

      if (uniqueNodes.length === 0) {
        nodesGrid.innerHTML = `<div style="grid-column: 1/-1; color: var(--muted); text-align: center; padding: 24px;">No nodes available</div>`;
        openModal("nodesModal");
        return;
      }

      uniqueNodes.forEach(node => {
        const nodeData = allData.find(row => (row["Node"] || row["Device_id"]) === node);
        const ph = parseFloat(nodeData?.["Ph"]);
        const temp = parseFloat(nodeData?.["Temp_c"]);
        const status = !isNaN(ph) ? "Active" : "Offline";

        const card = document.createElement("div");
        card.className = "node-card";
        card.innerHTML = `
          <div class="node-card-name">${node}</div>
          <div class="node-card-stat">pH: ${isNaN(ph) ? "-" : ph.toFixed(2)}</div>
          <div class="node-card-stat">Temp: ${isNaN(temp) ? "-" : temp.toFixed(1)}¬∞C</div>
          <span class="node-card-status">${status}</span>
        `;
        nodesGrid.appendChild(card);
      });

      openModal("nodesModal");
    }

    function showActiveAlertsModal() {
      const now = new Date().getTime();
      const activeAlerts = allData.filter(row => {
        const severity = (row["Severity"] || "INFO").toUpperCase();
        if (severity !== "CRITICAL" && severity !== "HIGH") return false;
        
        const timeStr = row["Time Stamp"] || "";
        const timestamp = new Date(timeStr).getTime();
        const ageMs = now - timestamp;
        
        return ageMs < ACTIVE_ALERT_WINDOW;
      });

      const alertsList = document.getElementById("activeAlertsList");
      alertsList.innerHTML = "";

      if (activeAlerts.length === 0) {
        alertsList.innerHTML = `<div style="color: var(--success); text-align: center; padding: 24px; font-weight: 700;">‚úÖ No active alerts</div>`;
        openModal("activeAlertsModal");
        return;
      }

      activeAlerts.forEach(alert => {
        const severity = (alert["Severity"] || "INFO").toUpperCase();
        const sevColor = severity === "CRITICAL" ? "#ff4c4c" : "#ff924c";
        
        const item = document.createElement("div");
        item.className = "alert-item-modal";
        item.style.borderLeftColor = sevColor;
        item.innerHTML = `
          <div class="alert-time-modal">${alert["Time Stamp"] || "-"}</div>
          <div class="alert-text-modal">${alert["Alert"] || "-"}</div>
          <span class="alert-severity-modal" style="background: ${sevColor}20; color: ${sevColor};">${severity}</span>
        `;
        item.addEventListener("click", () => showAlertResolution(alert));
        alertsList.appendChild(item);
      });

      openModal("activeAlertsModal");
    }

    function showSolvedAlertsModal() {
      const now = new Date().getTime();
      const solvedAlerts = allData.filter(row => {
        const severity = (row["Severity"] || "INFO").toUpperCase();
        if (severity !== "CRITICAL" && severity !== "HIGH") return false;
        
        const timeStr = row["Time Stamp"] || "";
        const timestamp = new Date(timeStr).getTime();
        const ageMs = now - timestamp;
        
        return ageMs >= ACTIVE_ALERT_WINDOW;
      });

      const alertsList = document.getElementById("solvedAlertsList");
      alertsList.innerHTML = "";

      if (solvedAlerts.length === 0) {
        alertsList.innerHTML = `<div style="color: var(--muted); text-align: center; padding: 24px; font-weight: 700;">No resolved alerts</div>`;
        openModal("solvedAlertsModal");
        return;
      }

      solvedAlerts.forEach(alert => {
        const severity = (alert["Severity"] || "INFO").toUpperCase();
        
        const item = document.createElement("div");
        item.className = "alert-item-modal";
        item.style.borderLeftColor = "#10b981";
        item.innerHTML = `
          <div class="alert-time-modal">${alert["Time Stamp"] || "-"}</div>
          <div class="alert-text-modal">${alert["Alert"] || "-"}</div>
          <span class="alert-severity-modal" style="background: #10b98120; color: #10b981;">RESOLVED</span>
        `;
        item.addEventListener("click", () => showAlertResolution(alert));
        alertsList.appendChild(item);
      });

      openModal("solvedAlertsModal");
    }

    function showTimeDetailsModal() {
      let maxTimestamp = "";
      allData.forEach(row => {
        const time = row["Time Stamp"] || "";
        if (time > maxTimestamp) {
          maxTimestamp = time;
        }
      });

      const dateObj = new Date(maxTimestamp);
      const formattedDate = dateObj.toLocaleDateString('en-IN', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      const formattedTime = dateObj.toLocaleTimeString('en-IN', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: true 
      });

      document.getElementById("timeDetailsContent").innerHTML = `
        <strong>${maxTimestamp || "-"}</strong><br>
        <span style="color: var(--accent-2); font-size: 13px; margin-top: 8px; display: block;">üìÖ ${formattedDate}</span>
        <span style="color: var(--accent); font-size: 13px; margin-top: 4px; display: block;">üïê ${formattedTime}</span>
      `;

      const recentRecords = allData.slice(0, 10);
      const recordsList = document.getElementById("recentRecordsList");
      recordsList.innerHTML = "";

      recentRecords.forEach((record, idx) => {
        const recordDiv = document.createElement("div");
        recordDiv.style.cssText = "background: rgba(0,212,255,0.05); border: 1px solid rgba(0,212,255,0.15); border-radius: 8px; padding: 10px; margin: 6px 0; font-size: 11px; color: var(--text-secondary);";
        recordDiv.innerHTML = `
          <strong style="color: var(--accent);">${idx + 1}. ${record["Node"] || "-"}</strong> @ ${record["Time Stamp"] || "-"}<br>
          pH: ${record["Ph"] || "-"} | Temp: ${record["Temp_c"] || "-"}¬∞C | ${record["Alert"] || "No alert"}
        `;
        recordsList.appendChild(recordDiv);
      });

      openModal("timeDetailsModal");
    }

    function showAlertResolution(alertData) {
      const now = new Date().getTime();
      const alertTimestamp = new Date(alertData["Time Stamp"] || "").getTime();
      const ageMs = now - alertTimestamp;
      
      const isRecent = ageMs < ACTIVE_ALERT_WINDOW;
      const actionTaken = (alertData["Action"] || "").trim();
      const cmdStatus = alertData["CommandStatus"] || "";
      const linkedUnits = alertData["LinkedUnits"] || [];
      
      document.getElementById("resolutionAlertText").textContent = alertData["Alert"] || "-";
      document.getElementById("resolutionIssue").textContent = alertData["Notes"] || "System detected anomaly";
      document.getElementById("resolutionAction").textContent = actionTaken || "No action required - Normal operation";
      
      document.getElementById("resolutionUnit").textContent = alertData["Unit_id"] || "-";
      document.getElementById("resolutionNode").textContent = alertData["Node"] || "-";
      
      document.getElementById("resolutionStartTime").textContent = alertData["Time Stamp"] || "-";
      
      const statusDiv = document.getElementById("resolutionStatus");
      
      if (actionTaken == 'NONE') {
        statusDiv.innerHTML = `<span style="color: #4df3c5;">‚ÑπÔ∏è NO ACTION REQUIRED - Normal operation</span>`;
        document.getElementById("resolutionEndTime").textContent = "‚Äî";
        document.getElementById("resolutionDuration").textContent = "Operating normally";
        document.getElementById("actionTracked").style.display = "none";
      } else if (isRecent) {
        statusDiv.innerHTML = `<span style="color: #ff6b6b;">üî¥ ACTIVE - Action in progress (${Math.round(ageMs / 1000 / 60)} min ago)</span>`;
        document.getElementById("resolutionEndTime").textContent = "Still active...";
        document.getElementById("resolutionDuration").textContent = `Active for ${Math.round(ageMs / 1000 / 60)} minutes`;
        document.getElementById("actionTracked").style.display = "block";
        
        const timerId = `${alertData["Node"]}_${alertData["Time Stamp"]}`;
        if (actionTimers[timerId]) clearTimeout(actionTimers[timerId]);
        
        const timeRemaining = ACTIVE_ALERT_WINDOW - ageMs;
        let timeLeft = Math.round(timeRemaining / 1000);
        
        const updateTimer = () => {
          const mins = Math.floor(timeLeft / 60);
          const secs = timeLeft % 60;
          document.getElementById("actionTimer").textContent = `${mins}:${secs < 10 ? '0' : ''}${secs} remaining until auto-resolved`;
          
          if (timeLeft <= 0) {
            document.getElementById("actionTracked").style.display = "none";
          } else {
            timeLeft--;
            actionTimers[timerId] = setTimeout(updateTimer, 1000);
          }
        };
        updateTimer();
      } else {
        const ageMinutes = Math.round(ageMs / 1000 / 60);
        statusDiv.innerHTML = `<span style="color: #10b981;">‚úÖ RESOLVED - Auto-resolved after ${ageMinutes} minutes</span>`;
        document.getElementById("resolutionEndTime").textContent = new Date(alertTimestamp + ACTIVE_ALERT_WINDOW).toLocaleTimeString();
        document.getElementById("resolutionDuration").textContent = `Resolved (was active for ~10 minutes)`;
        document.getElementById("actionTracked").style.display = "none";
        showNotification(`‚úÖ Alert Resolved: ${alertData["Alert"]}`);
      }

      const linkedSection = document.getElementById("linkedUnitsSection");
      const noLinkedMsg = document.getElementById("noLinkedUnitsMsg");
      const linkedList = document.getElementById("linkedUnitsList");

      if (linkedUnits.length > 0) {
        linkedSection.style.display = "block";
        noLinkedMsg.style.display = "none";
        linkedList.innerHTML = "";

        linkedUnits.forEach(linkedUnit => {
          const linkedDiv = document.createElement("div");
          linkedDiv.className = "linked-unit-item";
          
          let statusClass = "pending";
          let displayStatus = linkedUnit.Status || "PENDING";
          
          if (linkedUnit.Status === "SUCCESS") {
            statusClass = "success";
            displayStatus = "‚úÖ SUCCESS";
          } else if (linkedUnit.Status === "FAILED") {
            statusClass = "failed";
            displayStatus = "‚ùå FAILED";
          } else {
            statusClass = "pending";
            displayStatus = "‚è≥ PENDING";
          }

          linkedDiv.innerHTML = `
            <div class="linked-unit-name">üìç ${linkedUnit.LinkedUnit || "-"}</div>
            <div class="linked-unit-action">‚ö° Action: ${linkedUnit.LinkedAction || "-"}</div>
            <div class="linked-unit-severity">‚ö†Ô∏è Severity: ${linkedUnit.LinkedSeverity || "-"}</div>
            <div style="margin-top: 6px;">
              <span class="linked-unit-status ${statusClass}">${displayStatus}</span>
            </div>
          `;
          linkedList.appendChild(linkedDiv);
        });
      } else {
        linkedSection.style.display = "none";
        noLinkedMsg.style.display = "block";
      }

      openModal("alertResolutionModal");
    }

    function downloadFilteredReport() {
      if (currentFilteredHistoryData.length === 0) {
        showNotification("‚ùå No data to download with current filters", true);
        return;
      }

      const severity = document.getElementById("historySeverityFilter").value || "All";
      const limit = document.getElementById("historyLimitFilter").value;

      let csv = "Time,Unit,Node,Severity,Overall,Alert,Command Status,Action\n";
      
      currentFilteredHistoryData.forEach(row => {
        csv += `${row["Time Stamp"] || "-"},${row["Unit_id"] || "-"},${row["Node"] || "-"},${row["Severity"] || "-"},${row["OverallStatus"] || "-"},"${(row["Alert"] || "-").replace(/"/g, '""')}",${row["CommandStatus"] || "-"},"${(row["Action"] || "-").replace(/"/g, '""')}"\n`;
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", `ZyroEdge_Report_${severity}_${new Date().toISOString().slice(0, 10)}.csv`);
      link.click();
      
      showNotification(`üì• Report downloaded (${currentFilteredHistoryData.length} records, Severity: ${severity})`);
    }

    async function fetchDashboardData() {
      try {
        statusEl.innerHTML = "üîÑ Fetching...";
        
        const res = await fetch(API_ENDPOINT);
        const responseData = await res.json();

        let data = [];
        
        if (responseData.body) {
          try {
            const parsed = JSON.parse(responseData.body);
            if (parsed.history) data = parsed.history;
            else if (parsed.latest) data = parsed.latest;
            else data = Array.isArray(parsed) ? parsed : [];
          } catch (e) {}
        } else if (responseData.latest && Array.isArray(responseData.latest)) {
          data = responseData.latest;
        } else if (responseData.history && Array.isArray(responseData.history)) {
          data = responseData.history;
        } else if (Array.isArray(responseData)) {
          data = responseData;
        }

        if (!Array.isArray(data)) {
          data = [];
        }

        fullHistoryData = JSON.parse(JSON.stringify(data));
        allData = data;
        statusEl.innerHTML = "üü¢ Connected";

        updateAllTables();

      } catch (err) {
        console.error("‚ùå Error fetching data:", err);
        statusEl.innerHTML = "üî¥ Disconnected";
        systemHealthEl.innerHTML = "üî¥ CRITICAL";
        systemHealthEl.className = "emergency_off";
      }
    }

    function updateAllTables() {
      let data = allData;

      if (rolePermissions[currentRole] && rolePermissions[currentRole].unitRestricted && assignedUnit) {
        data = data.filter(row => (row["Unit_id"] || "") === assignedUnit);
      }

      updateSystemHealth(data);

      const liveTbody = document.querySelector("#liveDataTable tbody");
      const overviewTbody = document.querySelector("#overviewTable tbody");
      const actuatorTbody = document.querySelector("#actuatorTable tbody");
      const alertsList = document.getElementById("alertsList");
      
      liveTbody.innerHTML = ""; overviewTbody.innerHTML = ""; actuatorTbody.innerHTML = "";
      alertsList.innerHTML = "";

      phData.length = 0; tdsData.length = 0; tempData.length = 0; timeLabels.length = 0;

      let activeAlertCount = 0;
      let solvedAlertCount = 0;
      const latestByNode = {};
      const latestActuatorByNode = {};
      const unitNodeMap = {};
      const perms = rolePermissions[currentRole];

      let maxTimestamp = "";
      data.forEach(row => {
        const time = row["Time Stamp"] || "";
        if (time > maxTimestamp) {
          maxTimestamp = time;
        }
      });

      data.forEach(row => {
        const node = row["Node"] || row["Device_id"] || "-";
        
        if (!latestByNode[node]) {
          latestByNode[node] = row;
        }

        if (!latestActuatorByNode[node] && row["Actuator_state"]) {
          latestActuatorByNode[node] = row;
        }
      });

      Object.keys(latestByNode).forEach(node => {
        const unit = latestByNode[node]["Unit_id"] || "UNIT-A";
        if (!unitNodeMap[unit]) unitNodeMap[unit] = [];
        unitNodeMap[unit].push(node);
      });

      const now = new Date().getTime();
      data.forEach(row => {
        const severity = (row["Severity"] || "INFO").toUpperCase();
        if ((severity === "CRITICAL" || severity === "HIGH") && perms && perms.alertFilter(row)) {
          const timeStr = row["Time Stamp"] || "";
          const timestamp = new Date(timeStr).getTime();
          const ageMs = now - timestamp;

          if (ageMs < ACTIVE_ALERT_WINDOW) {
            activeAlertCount++;
          } else {
            solvedAlertCount++;
          }
        }
      });

      if (perms && perms.sections.includes('liveData')) {
        data.forEach(row => {
          const time = row["Time Stamp"] || row["Timestamp"] || "-";
          const unit = row["Unit_id"] || row["Node"] || "-";
          const node = row["Node"] || row["Device_id"] || "-";
          const ph = parseFloat(row["Ph"]);
          const tds = parseFloat(row["Tds_ppm"]);
          const temp = parseFloat(row["Temp_c"]);
          const flow = parseFloat(row["Flow_lpm"]);
          const pressure = parseFloat(row["Pressure_bar"]);
          const level = parseFloat(row["Level_pct"]);
          const severity = (row["Severity"] || "INFO").toUpperCase();

          const trLive = document.createElement("tr");
          trLive.style.cursor = "pointer";
          trLive.innerHTML = `
            <td>${time}</td><td>${unit}</td><td>${node}</td>
            <td>${isNaN(ph) ? "-" : ph.toFixed(2)}</td>
            <td>${isNaN(tds) ? "-" : tds.toFixed(1)}</td>
            <td>${isNaN(temp) ? "-" : temp.toFixed(1)}</td>
            <td>${isNaN(flow) ? "-" : flow.toFixed(2)}</td>
            <td>${isNaN(pressure) ? "-" : pressure.toFixed(2)}</td>
            <td>${isNaN(level) ? "-" : level.toFixed(1)}</td>
            <td>${sevBadge(severity)}</td>
          `;
          trLive.addEventListener("click", () => showAlertResolution(row));
          liveTbody.appendChild(trLive);
        });
      }

      if (perms && perms.sections.includes('graphs')) {
        Object.keys(latestByNode).forEach(node => {
          const row = latestByNode[node];
          const time = row["Time Stamp"] || "-";
          const ph = parseFloat(row["Ph"]);
          const tds = parseFloat(row["Tds_ppm"]);
          const temp = parseFloat(row["Temp_c"]);

          if (!isNaN(ph) && !timeLabels.includes(time)) {
            phData.push(ph); tdsData.push(isNaN(tds) ? 0 : tds); tempData.push(isNaN(temp) ? 0 : temp);
            timeLabels.push(time);
            if (timeLabels.length > 20) { phData.shift(); tdsData.shift(); tempData.shift(); timeLabels.shift(); }
          }
        });
      }

      if (perms && perms.sections.includes('actuators')) {
        Object.keys(latestActuatorByNode).forEach(node => {
          const row = latestActuatorByNode[node];
          const time = row["Time Stamp"] || "-";
          const unit = row["Unit_id"] || "-";
          const action = row["Action"] || "";
          const vibration = parseFloat(row["Vibration_rms"]);
          let actuatorState = row["Actuator_state"] || "";
          
          if (actuatorStates[node]) {
            actuatorState = actuatorStates[node];
          }

          const trAct = document.createElement("tr");
          const btnOn = document.createElement("button");
          btnOn.textContent = "ON"; btnOn.className = "control-btn btn-on";
          const btnOff = document.createElement("button");
          btnOff.textContent = "OFF"; btnOff.className = "control-btn btn-off";

          const locked = ["EMERGENCY_OFF","BACKUP_ON","BACKUP_SENSOR"].includes(actuatorState);
          if (!perms.canControl || locked || actuatorState === "ON") {
            btnOn.classList.add("btn-disabled"); btnOn.disabled = true;
          }
          if (!perms.canControl || locked || actuatorState === "OFF") {
            btnOff.classList.add("btn-disabled"); btnOff.disabled = true;
          }

          btnOn.addEventListener("click", async () => {
            btnOn.classList.add("btn-loading");
            btnOff.classList.add("btn-loading");
            await sendManualCommand(node, "ON");
            btnOn.classList.remove("btn-loading");
            btnOff.classList.remove("btn-loading");
          });
          btnOff.addEventListener("click", async () => {
            btnOn.classList.add("btn-loading");
            btnOff.classList.add("btn-loading");
            await sendManualCommand(node, "OFF");
            btnOn.classList.remove("btn-loading");
            btnOff.classList.remove("btn-loading");
          });

          const controlsTd = document.createElement("td");
          if (perms.canControl) {
            controlsTd.appendChild(btnOn); controlsTd.appendChild(btnOff);
          } else {
            controlsTd.innerHTML = '<span style="color:var(--muted);font-size:12px;">üîí No Access</span>';
          }

          trAct.innerHTML = `
            <td>${time}</td><td>${unit}</td><td>${node}</td>
            <td><span class="state-badge ${actuatorStateInfo[actuatorState]?.className || ''}">${actuatorStateInfo[actuatorState]?.display || actuatorState}</span></td>
            <td>${action || "-"}</td>
            <td>${isNaN(vibration) ? "-" : vibration.toFixed(3)}</td>
          `;
          trAct.appendChild(controlsTd);
          actuatorTbody.appendChild(trAct);
        });
      }

      if (perms && perms.sections.includes('overview')) {
        const overviewTbody = document.querySelector("#overviewTable tbody");
        Object.keys(latestByNode).forEach(node => {
          const d = latestByNode[node];
          const unit = d["Unit_id"] || "-";
          const ph = parseFloat(d["Ph"]);
          const tds = parseFloat(d["Tds_ppm"]);
          const temp = parseFloat(d["Temp_c"]);
          const time = d["Time Stamp"] || "-";
          const overall = d["OverallStatus"] || "-";
          const status = !isNaN(ph) ? "üü¢ Active" : "üî¥ Offline";
          
          const tr = document.createElement("tr");
          tr.style.cursor = "pointer";
          tr.innerHTML = `
            <td>${unit}</td><td>${node}</td><td>${status}</td>
            <td>${isNaN(ph) ? "-" : ph.toFixed(2)}</td>
            <td>${isNaN(tds) ? "-" : tds.toFixed(1)}</td>
            <td>${isNaN(temp) ? "-" : temp.toFixed(1)}</td>
            <td>${time}</td><td>${overall}</td>
          `;
          overviewTbody.appendChild(tr);
        });
      }

      if (perms && perms.sections.includes('alerts')) {
        data.forEach(row => {
          const severity = (row["Severity"] || "INFO").toUpperCase();
          const alertText = row["Alert"] || row["Notes"] || "";
          const action = row["Action"] || "";
          const unit = row["Unit_id"] || "-";
          const node = row["Node"] || "-";
          
          if (perms.alertFilter(row)) {
            const li = document.createElement("li");
            li.className = severity === "CRITICAL" ? "alert" : "action";
            li.textContent = `[${severity}] ${unit}/${node}: ${alertText} ${action ? "‚Üí " + action : ""}`;
            li.addEventListener("click", () => showAlertResolution(row));
            alertsList.appendChild(li);
          }
        });
      }

      if (perms && perms.sections.includes('overview')) {
        const gridDiv = document.getElementById("unitHealthGrid");
        gridDiv.innerHTML = "";
        
        ["UNIT-A", "UNIT-B", "UNIT-C", "UNIT-D", "UNIT-E"].forEach(unitId => {
          const nodes = unitNodeMap[unitId] || [];
          const activeNodes = nodes.filter(n => latestByNode[n] && !isNaN(parseFloat(latestByNode[n]["Ph"]))).length;
          const avgPh = nodes.reduce((sum, n) => sum + parseFloat(latestByNode[n]?.["Ph"] || 0), 0) / (nodes.length || 1);
          const avgTemp = nodes.reduce((sum, n) => sum + parseFloat(latestByNode[n]?.["Temp_c"] || 0), 0) / (nodes.length || 1);
          
          const card = document.createElement("div");
          card.className = "unit-health-card";
          card.innerHTML = `
            <div class="unit-health-header">
              <span class="unit-health-title">${unitId}</span>
              <span class="unit-health-status">${activeNodes}/${nodes.length} Active</span>
            </div>
            <div class="unit-health-content">
              <div class="health-stat">
                <span class="health-label">Avg pH:</span>
                <span class="health-value">${isNaN(avgPh) ? "-" : avgPh.toFixed(2)}</span>
              </div>
              <div class="health-stat">
                <span class="health-label">Avg Temp:</span>
                <span class="health-value">${isNaN(avgTemp) ? "-" : avgTemp.toFixed(1)}¬∞C</span>
              </div>
              <div class="health-stat">
                <span class="health-label">Nodes:</span>
                <span class="health-value">${nodes.length}</span>
              </div>
            </div>
            <div class="nodes-list">
              ${nodes.map(n => `<div class="node-item"><span class="node-name">${n}</span><span class="node-status">Active</span></div>`).join('')}
            </div>
          `;
          card.addEventListener("click", () => openUnitDetails(unitId));
          gridDiv.appendChild(card);
        });
      }

      const uniqueNodes = new Set(data.map(r => r["Node"] || r["Device_id"]));
      document.getElementById("activeNodes").textContent = uniqueNodes.size;
      document.getElementById("dataPoints").textContent = fullHistoryData.length;
      document.getElementById("activeAlerts").textContent = activeAlertCount;
      document.getElementById("solvedAlerts").textContent = solvedAlertCount;
      
      const timeOnly = (maxTimestamp.split("T")[1] || maxTimestamp).substring(0, 8);
      document.getElementById("lastUpdateTime").textContent = timeOnly || "-";

      if (maxTimestamp) {
        const dateObj = new Date(maxTimestamp);
        const dateStr = dateObj.toLocaleDateString('en-IN', { month: 'short', day: '2-digit' });
        document.getElementById("lastUpdateDate").textContent = dateStr;
      } else {
        document.getElementById("lastUpdateDate").textContent = "-";
      }

      phChart.update(); tdsChart.update(); tempChart.update();
    }

    function updateSystemHealth(data) {
      const latest = data && data.length ? data[0] : null;
      if (!latest) {
        systemHealthEl.innerHTML = "üü£ SAFE MODE";
        systemHealthEl.className = "safe";
        return;
      }
      const overall = latest["OverallStatus"] || "";
      systemHealthEl.innerHTML = overall || "üü¢ OPTIMAL";
      systemHealthEl.className = overallToClass(overall);
    }

    function sevBadge(sev) {
      const s = (sev || "").toUpperCase();
      const color = s === "CRITICAL" ? "#ff4c4c" : s === "HIGH" ? "#ff924c" : s === "MEDIUM" ? "#fbbf24" : s === "LOW" ? "#93c5fd" : "#00d4ff";
      return `<span style="padding:8px 12px;border-radius:16px;font-weight:800;background:${color};color:#03131a;display:inline-block;font-size:11px;letter-spacing:0.5px">${s || "INFO"}</span>`;
    }

    function overallToClass(overall) {
      if (!overall) return "safe";
      const t = overall.toUpperCase();
      if (t.includes("CRITICAL")) return "emergency_off";
      if (t.includes("OPTIMAL")) return "optimal";
      if (t.includes("DANGER")) return "danger";
      return "safe";
    }

    async function sendManualCommand(node, cmd) {
      try {
        const response = await fetch(API_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ targetNode: node, command: cmd })
        });

        const result = await response.json();

        if (response.ok) {
          actuatorStates[node] = cmd;
          showNotification(`‚úÖ Command '${cmd}' sent to '${node}'`);
          setTimeout(() => fetchDashboardData(), 500);
        } else {
          showNotification(`‚ùå Failed: ${result.error || response.statusText}`, true);
        }
      } catch (err) {
        showNotification("‚ùå Error sending command: " + err.message, true);
      }
    }

    function openUnitDetails(unitId) {
      const unitData = allData.filter(row => (row["Unit_id"] || "") === unitId);
      const nodesByUnit = {};
      
      unitData.forEach(row => {
        const node = row["Node"] || "-";
        if (!nodesByUnit[node]) {
          nodesByUnit[node] = row;
        }
      });

      document.getElementById("modalUnitName").textContent = unitId;
      
      const gridDiv = document.getElementById("nodeDetailsGrid");
      gridDiv.innerHTML = "";
      
      Object.keys(nodesByUnit).forEach(node => {
        const data = nodesByUnit[node];
        const ph = parseFloat(data["Ph"]);
        const temp = parseFloat(data["Temp_c"]);
        const status = !isNaN(ph) ? "Active" : "Offline";
        
        const card = document.createElement("div");
        card.className = "node-detail-card";
        card.innerHTML = `
          <div class="node-detail-label">${node}</div>
          <div class="node-detail-value">${status}</div>
          <div style="font-size: 11px; color: var(--muted); margin-top: 6px;">pH: ${isNaN(ph) ? "-" : ph.toFixed(2)}</div>
          <div style="font-size: 11px; color: var(--muted);">Temp: ${isNaN(temp) ? "-" : temp.toFixed(1)}¬∞C</div>
        `;
        card.addEventListener("click", () => showNodeAlerts(unitId, node));
        gridDiv.appendChild(card);
      });

      openModal("unitDetailsModal");
    }

    function showNodeAlerts(unitId, node) {
      const nodeAlerts = allData.filter(row => 
        (row["Unit_id"] || "") === unitId && 
        (row["Node"] || "") === node &&
        row["Alert"] && row["Alert"].trim() !== ""
      );

      const alertList = document.getElementById("alertHistoryList");
      alertList.innerHTML = "";

      if (nodeAlerts.length === 0) {
        alertList.innerHTML = `<div style="color: var(--success); font-weight: 700;">‚úÖ No alerts for this node</div>`;
        return;
      }

      nodeAlerts.forEach(alert => {
        const severity = (alert["Severity"] || "INFO").toUpperCase();
        const statusClass = ["CRITICAL", "HIGH"].includes(severity) ? "alert-status-active" : "alert-status-resolved";
        const item = document.createElement("div");
        item.className = "alert-history-item";
        item.innerHTML = `
          <div class="alert-history-time">${alert["Time Stamp"] || "-"}</div>
          <div style="color: var(--text); margin: 8px 0; font-weight: 700;">${alert["Alert"] || "-"}</div>
          <div class="alert-history-status ${statusClass}">${severity}</div>
        `;
        item.addEventListener("click", () => showAlertResolution(alert));
        alertList.appendChild(item);
      });
    }

    function applyHistoryFilters() {
      const severity = document.getElementById("historySeverityFilter").value;
      const limit = parseInt(document.getElementById("historyLimitFilter").value) || 10000;
      
      let filteredData = fullHistoryData;
      
      if (severity) {
        filteredData = filteredData.filter(row => (row["Severity"] || "INFO").toUpperCase() === severity);
      }
      
      filteredData = filteredData.slice(0, limit);
      currentFilteredHistoryData = filteredData;
      
      const historyTbody = document.querySelector("#historyTable tbody");
      historyTbody.innerHTML = "";
      
      const perms = rolePermissions[currentRole];
      
      filteredData.forEach(row => {
        if (perms && perms.sections.includes('history')) {
          const time = row["Time Stamp"] || "-";
          const unit = row["Unit_id"] || "-";
          const node = row["Node"] || "-";
          const severity = (row["Severity"] || "INFO").toUpperCase();
          const overall = row["OverallStatus"] || "-";
          const alertText = row["Alert"] || "-";
          const cmdStatus = row["CommandStatus"] || "-";
          
          const trH = document.createElement("tr");
          trH.style.cursor = "pointer";
          trH.innerHTML = `
            <td>${time}</td><td>${unit}</td><td>${node}</td>
            <td>${sevBadge(severity)}</td>
            <td>${overall}</td>
            <td>${alertText}</td>
            <td style="font-size:11px;font-weight:700;color:var(--accent);">${cmdStatus}</td>
          `;
          trH.addEventListener("click", () => showAlertResolution(row));
          historyTbody.appendChild(trH);
        }
      });
    }
  </script>
</body>
</html>